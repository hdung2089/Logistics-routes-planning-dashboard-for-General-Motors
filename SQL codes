PROJECT 1

DROP TABLE IF EXISTS #TempSO;

-- Create temporary table to store results of the first query
CREATE TABLE #TempSO (
    [SO#] NVARCHAR(255),
    ORDER_ID INT,
    STATUS_TYPE_DESCRIPTION NVARCHAR(255),
    OMS_PRE_ADVISE_GROUP_STATUS_TYPE_ID INT,
    COUNTRY_CODE NVARCHAR(3),
    Origin NVARCHAR(3),
    DESCRIPTION NVARCHAR(255)
);

-- Insert data from the first query into the temporary table
INSERT INTO #TempSO
SELECT 
    v.REFERENCE_NUMBER as [SO#],
    od.ORDER_ID,
    o.STATUS_TYPE_DESCRIPTION,
    o.OMS_PRE_ADVISE_GROUP_STATUS_TYPE_ID,
    a.COUNTRY_CODE,
    a1.COUNTRY_CODE as [Origin],
    p.DESCRIPTION
FROM orders od
LEFT JOIN ADDRESS_DETAIL_INSTANCE a 
    ON a.ADDRESS_DETAIL_ID = od.ADDRESS_DETAIL_ID
LEFT JOIN ADDRESS_DETAIL_INSTANCE a1 
    ON a1.ADDRESS_DETAIL_ID = od.ORIGIN_ADDRESS_DETAIL_ID
LEFT JOIN ORDER_REFERENCE_VIEW v 
    ON v.ORDER_ID = od.ORDER_ID 
    AND v.REFERENCE_TYPE_ID = 100742
LEFT JOIN OMS_PRE_ADVISE_GROUP_LISTITEM_VIEW o 
    ON o.OMS_PRE_ADVISE_GROUP_ID = TRY_CAST(v.REFERENCE_NUMBER AS INT)
LEFT JOIN oms_pre_advise_group o1 
    ON o1.OMS_PRE_ADVISE_GROUP_ID = TRY_CAST(v.REFERENCE_NUMBER AS INT)
LEFT JOIN PATH_TYPE_VIEW p 
    ON p.PATH_TYPE_ID = o1.PATH_TYPE_ID
WHERE od.BUSINESS_UNIT_ID = 242 
    AND a.COUNTRY_CODE IN ('MEX', 'CAN', 'USA')
    AND od.CREATION_DATETIME BETWEEN '01-01-2025' AND '12-31-2025';

-- Second query using the temporary table
SELECT 
    t.[SO#],
    t.ORDER_ID,
    t.COUNTRY_CODE,
    t.Origin,
    t.DESCRIPTION as 'SO Status',
    es.EM_SHIPMENT_ID,
    es.CURRENT_STATE_TYPE_ID as 'STI status',
    e.EXPECTED_FULFILLMENT_DATETIME_LOCAL as 'ETD',
    e.FULFILLMENT_DATETIME_LOCAL as 'ATA',
    a.REFERENCE_NUMBER as [SO],
    e.MASTER_UNITLOAD_ID,
    t2.CONVEYANCE_ID_NUMBER,
    t2.CONVEYANCE_TYPE_DESC as 'Cont type',
    M2.REFERENCE_NUMBER AS 'VESSEL NAME',
    M3.REFERENCE_NUMBER AS 'SCAC'

FROM em_shipment es 
LEFT JOIN EM_SHIPMENT_REFERENCE_LISTITEM_VIEW a 
    ON a.EM_SHIPMENT_ID = es.EM_SHIPMENT_ID 
    AND a.DESCRIPTION IN ('Shipping Order Number')
LEFT JOIN EM_SHIPMENT_OPERATIONAL_MILESTONE e 
    ON e.EM_SHIPMENT_ID = es.EM_SHIPMENT_ID
LEFT JOIN MTI_OVERVIEW_LISTITEM_VIEW t2 
    ON t2.MASTER_UNITLOAD_ID = e.MASTER_UNITLOAD_ID
LEFT JOIN MASTER_UL_REFERENCE_VIEW M2 
    ON M2.MASTER_UNITLOAD_ID = em.MASTER_UNITLOAD_ID AND M2.REFERENCE_TYPE_ID =100135
LEFT JOIN MASTER_UL_REFERENCE_VIEW M3 
    ON M3.MASTER_UNITLOAD_ID = em.MASTER_UNITLOAD_ID AND M3.REFERENCE_TYPE_ID =100755
INNER JOIN #TempSO t 
    ON a.REFERENCE_NUMBER = t.[SO#]
WHERE es.CURRENT_STATE_TYPE_ID = 100000;

-- Clean up the temporary table
DROP TABLE #TempSO;



